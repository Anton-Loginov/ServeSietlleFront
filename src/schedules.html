<!doctype html>
<html lang="en">
<head>
    <title>Schedules</title>
    <!--META-->
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- FAVICON -->
    <link rel="apple-touch-icon" sizes="57x57" href="img/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="img/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="img/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="img/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="img/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="img/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="img/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="img/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="img/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="img/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="manifest" href="img/manifest.json">

    <!-- LINKS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
          type="text/css">
    <link href='../node_modules/fullcalendar/dist/fullcalendar.min.css' rel='stylesheet'/>
    <link href='../node_modules/fullcalendar/dist/fullcalendar.print.min.css' rel='stylesheet' media='print'/>
    <link href='../node_modules/bootstrap/dist/css/bootstrap.min.css' rel='stylesheet'/>
    <link href='../node_modules/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css'
          rel='stylesheet'/>
    <link href='../node_modules/bootstrap-select/dist/css/bootstrap-select.min.css' rel='stylesheet'/>
    <link href="css/index.min.css" type="text/css" rel="stylesheet">
</head>
<body>
<header class="header">
    <div class="container">
        <a href="dashboard.html" class="header-logo pull-left">
            <img src="./img/SS_logo.jpeg" alt="logotype">
        </a>
        <ul class="nav navbar-nav pull-right">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="schedules.html">Schedules</a></li>
            <li><a href="request_forms.html">Request forms</a></li>
            <li><a href="surveys.html">Surveys</a></li>
            <li><a href="#">Users</a></li>
        </ul>
    </div>
</header>
<main>
    <div class="schedules">
        <div class="container">
            <div class="page-title">
                <h1>Schedules</h1>
                <div id='calendar'></div>
            </div>
        </div>
    </div>
</main>

<!--event modal-->
<div id="eventModal" class="popup modal fade in" tabindex="1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="modal-header">
                <h3 class="text-center">Add event</h3>
            </div>
        </div>
        <div class="row-fluid">
            <div class="input-group">
                <form action="" id="formNewEvent">
                    <input
                            type="text"
                            class="form-control"
                            placeholder="Title"
                            name="name"
                            id="eventTitle"
                    >
                    <input
                            required
                            type="text"
                            class="form-control"
                            placeholder="Event location"
                            name="location"
                            id="eventLocation"
                    >
                    <input
                            required
                            type="text"
                            placeholder="Event start"
                            class="form-control"
                            name="start"
                            id="eventStart"
                            onkeydown="return false"
                    >
                    <input
                            required
                            type="text"
                            class="form-control"
                            name="end"
                            placeholder="Event end "
                            id="eventEnd"
                            onkeydown="return false"
                    >
                    <textarea
                            required
                            id="eventDescription"
                            class="form-control"
                            name="description"
                            placeholder="Description"
                            rows="5">
                    </textarea>
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="form-group">
                                <h3 class="id-users text-center">ID-users</h3>
                                <select id="select-user" class="selectpicker form-control" multiple
                                        data-live-search="true">
                                </select>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success" id="submitEvent" type="submit">
                        Submit
                    </button>
                    <button class="btn btn-danger pull-right" data-dismiss="modal">
                        Cancel
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!--updateEvent modal-->
<div id="updateEvent" class="popup modal fade in" tabindex="1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="modal-header">
                <h3 class="text-center">Edit event</h3>
            </div>
        </div>
        <div class="row-fluid">
            <div class="input-group">
                <form action="" id="formUpdateEvent">
                    <input
                            required
                            type="text"
                            class="form-control"
                            placeholder="Title"
                            id="updateTitle"
                            name="name"
                    >
                    <input
                            required
                            type="text"
                            class="form-control"
                            placeholder="Event location"
                            id="updateLocation"
                            name="location"
                    >
                    <input
                            required
                            type="text"
                            placeholder="Event start"
                            class="form-control"
                            id="updateStart"
                            onkeydown="return false"
                            name="start"
                    >
                    <input
                            required
                            type="text"
                            class="form-control"
                            placeholder="Event end "
                            id="updateEnd"
                            onkeydown="return false"
                            name="end"
                    >
                    <textarea
                            required
                            id="updateDescription"
                            class="form-control"
                            name="description"
                            placeholder="Description"
                            rows="5">
                    </textarea>
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="form-group">
                                <h3 class="id-users text-center">ID-users</h3>
                                <select id="update-user" class="selectpicker form-control" multiple
                                        data-live-search="true">
                                </select>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success" id="updateSubmit" type="submit">
                        Save change
                    </button>
                    <button class="btn btn-warning" data-dismiss="modal" id="removeEventBtn">
                        Remove
                    </button>
                    <button class="btn btn-danger pull-right" data-dismiss="modal">
                        Cancel
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>


<!--SCRIPTS-->
<script src='../node_modules/moment/min/moment.min.js'></script>
<script src='../node_modules/jquery/dist/jquery.min.js'></script>
<script src="../node_modules/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="js/jquery-ui.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
<script src='../node_modules/fullcalendar/dist/fullcalendar.min.js'></script>
<script src='../node_modules/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js'></script>
<script src='../node_modules/bootstrap-select/dist/js/bootstrap-select.min.js'></script>
<script src='../node_modules/fullcalendar/dist/gcal.min.js'></script>
<script src="js/index.js"></script>
<script>

    $(document).ready(function () {

//  New Event
        var eventModal = $('#eventModal');
        var eventTitle = $('#eventTitle');
        var eventStart = $('#eventStart');
        var eventEnd = $('#eventEnd');
        var eventLocation = $('#eventLocation');
        var eventDescription = $('#eventDescription');
        var eventUser = $('#select-user');
        var eventSubmit = $('#submitEvent');

//  Update Event
        var updateEvent = $('#updateEvent');
        var updateTitle = $('#updateTitle');
        var updateStart = $('#updateStart');
        var updateEnd = $('#updateEnd');
        var updateLocation = $('#updateLocation');
        var updateDescription = $('#updateDescription');
        var updateUser = $('#update-user');
        var updateSubmit = $('#updateSubmit');

//  Calendar
        var calendar = $('#calendar');
        var removeEventBtn = $('#removeEventBtn');
        var currentEvent;
//  Format date

        $('#formNewEvent').validate({
            rules: {
                name: "required",
                start: "required",
                end: "required",
                location: "required",
                description: "required"
            }
        });
        $('#formUpdateEvent').validate({
            rules: {
                name: "required",
                start: "required",
                end: "required",
                location: "required",
                description: "required"
            }
        });

        $.ajax({
            "async": true,
            "crossDomain": true,
            "url": "http://104.236.31.247/users-list",
            "method": "GET",
            "headers": {
                "content-type": "application/json",
                "authorization": "Basic YWRtaW5Ac2VydmUtc2VhdHRsZS5jb206YWRtaW4="
            },
            "processData": false
        }).done(function (response) {
            console.log('ok');
            response.users.forEach(function (elem, index) {
                updateUser.append('<option value="' + elem.id + '">' + elem.firstName + ' ' + elem.lastName +
                    '</option>');
                eventUser.append('<option value="' + elem.id + '">' + elem.firstName + ' ' + elem.lastName +
                    '</option>');
            });
            $('.selectpicker').selectpicker('refresh');
        });

        $('#eventStart, #eventEnd,#updateStart, #updateEnd').datetimepicker({
            format: "DD.MM.YYYY HH:mm"
        });

        calendar.fullCalendar({
            googleCalendarApiKey: 'AIzaSyCvhIy1Sbln1q5m48C_ojM-KKl9JSoNdRc',
            customButtons: {
                newEvent: {
                    text: 'New event',
                    click: function (event) {
                        eventTitle.val('');
                        eventDescription.val('');
                        eventLocation.val('');
                        eventStart.val();
                        eventEnd.val();
                        eventModal.modal('show');
                        eventTitle.focus();
                    }
                }
            },
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay, newEvent'
            },
            navLinks: true, // can click day/week names to navigate views
            selectable: true,
            selectHelper: true,
            editable: true,
            timeFormat: 'H:mm',
            eventRender: function (event, element) {
                element.find('.fc-title').append('<div class="hr-line-solid-no-margin"><span style="font-size: 10px">' + event.description + '</span></div>');
            },
            eventClick: function (event, element) {
                updateUser.selectpicker('val', event.user);
                currentEvent = event;
                updateTitle.val(event.title);
                updateDescription.val(event.description);
                updateLocation.val(event.location);
                updateStart.val(event.start.format("DD.MM.YYYY HH:mm"));
                if (event.end == null) {
                    updateEnd.val(event.start.format("DD.MM.YYYY HH:mm"));
                } else {
                    updateEnd.val(event.end.format("DD.MM.YYYY HH:mm"));
                }
                updateEvent.modal('show');
                updateTitle.focus();


            },
            eventLimit: true, // allow "more" link when too many events
            events: function (start, end, timezone, callback) {
                var view = $('#calendar').fullCalendar('getView'),
                    start = view.start._d.toISOString(),
                    end = view.end._d.toISOString();

                $.ajax({
                    "async": true,
                    "crossDomain": true,
                    "url": "http://104.236.31.247/schedule/events?singleEvents=1&timeMin=" + start +
                    "&timeMax=" + end,
                    "method": "GET",
                    "headers": {
                        "content-type": "application/json",
                        "authorization": "Basic YWRtaW5Ac2VydmUtc2VhdHRsZS5jb206YWRtaW4=",
                        "cache-control": "no-cache"
                    },
                    "processData": false,
                    success: function (data) {
                        var events = [];
                        data.events.forEach(function (elem, index) {
                            events.push(elem);
                            var time = moment.duration("07:00:00");
                            events[index].start = (moment(elem.start).subtract(time).toISOString());
                            events[index].end = (moment(elem.end).subtract(time).toISOString());
                        });
                        callback(events);
                    }
                });
            }
        });

        eventSubmit.on('click', function (e) {
            e.preventDefault();
            if ($('#formNewEvent').valid()) {
                doSubmit();
            }
        });

        updateSubmit.on('click', function (e) {
            e.preventDefault();
            if ($('#formUpdateEvent').valid()) {
                updateEventSubmit(currentEvent);
            }
        });

        removeEventBtn.on('click', function (e) {
            e.preventDefault();
            removeEvent(currentEvent);
        });

        function doSubmit() {
            var eventData = {
                "event": {
                    "user": eventUser.val(),
                    "summary": eventTitle.val(),
                    "description": eventDescription.val(),
                    "location": eventLocation.val(),
                    "start": moment(eventStart.val(), "DD.MM.YYYY HH:mm").format("YYYY-MM-DDTHH:mm:ss") + '-07:00',
                    "end": moment(eventEnd.val(), "DD.MM.YYYY HH:mm").format("YYYY-MM-DDTHH:mm:ss") + '-07:00'
                }
            };
            console.log(event);

            var newEvent = {
                "async": true,
                "crossDomain": true,
                "url": "http://104.236.31.247/schedule/events",
                "method": "POST",
                "headers": {
                    "content-type": "application/json",
                    "authorization": "Basic YWRtaW5Ac2VydmUtc2VhdHRsZS5jb206YWRtaW4=",
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify(eventData)
            };

            $.ajax(newEvent).done(function (response) {
                console.log(response);
                setTimeout("window.location.reload()", 500);
            });
            eventModal.modal('hide');
        }

        function updateEventSubmit(event) {
            var eventData = {
                "event": {
                    "user": updateUser.val(eventUser.val()),
                    "summary": updateTitle.val(),
                    "description": updateDescription.val(),
                    "location": updateLocation.val(),
                    "start": moment(updateStart.val(), "DD.MM.YYYY HH:mm").format("YYYY-MM-DDTHH:mm:ss") + '-07:00',
                    "end": moment(updateEnd.val(), "DD.MM.YYYY HH:mm").format("YYYY-MM-DDTHH:mm:ss") + '-07:00'
                }
            };

            var update = {
                "async": true,
                "crossDomain": true,
                "url": "http://104.236.31.247/schedule/events/" + event.id,
                "method": "PATCH",
                "headers": {
                    "content-type": "application/json",
                    "authorization": "Basic YWRtaW5Ac2VydmUtc2VhdHRsZS5jb206YWRtaW4=",
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify(eventData)
            };

            $.ajax(update).done(function (response) {
                console.log(response);
                setTimeout("window.location.reload()", 500);

            });
            updateEvent.modal('hide');
            $('#calendar').fullCalendar('updateEvent', event.id);


        }

        function removeEvent(event) {
            var removeEvent = {
                "async": true,
                "crossDomain": true,
                "url": "http://104.236.31.247/app_dev.php/schedule/events/" + event.id,
                "method": "DELETE",
                "headers": {
                    "content-type": "application/json",
                    "authorization": "Basic YWRtaW5Ac2VydmUtc2VhdHRsZS5jb206YWRtaW4=",
                    "cache-control": "no-cache"
                },
                "processData": false
            };

            $.ajax(removeEvent).done(function (response) {
                console.log(response);
            });

            calendar.fullCalendar('removeEvents', event.id);
        }
    });

</script>
</body>
</html>